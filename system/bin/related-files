#!/usr/bin/env ruby

require 'json'

class RelatedFileFinder
  attr_reader :pattern_map

  class Pattern
    attr_reader :regexp, :related_file_pattern

    def initialize(regexp, related_file_pattern)
      @regexp = regexp
      @related_file_pattern = related_file_pattern
    end

    def match(file)
      match = regexp.match(file)
      yield build_related_file_glob(match) if match
    end

    private

    def build_related_file_glob(match)
      related_file_pattern.gsub(/\$(\d+)/) { |matched_param| match[$1.to_i] }
    end
  end

  def initialize(config = {})
    @pattern_map = config
  end

  def load_config(filename)
    return unless File.exist?(filename)

    config = JSON.parse(File.read(filename))
    config.each do |base, related|
      pattern_map[base] ||= []
      pattern_map[base] += Array(related)
    end
  end

  def related_files(file)
    return [] unless File.exist?(file)

    patterns.each_with_object([file]) do |pattern, related|
      pattern.match(file) do |related_file_glob|
        related.concat(Dir.glob(related_file_glob))
      end
    end
  end

  private

  def patterns
    @patterns ||= pattern_map.flat_map do |regexp_str, related_list|
      regexp = Regexp.new(regexp_str)
      related_list.map { |related| Pattern.new(regexp, related) }
    end
  end
end

def load_files_from_stdin
  $stdin.stat.pipe? ? $stdin.readlines(chomp: true) : []
end

finder = RelatedFileFinder.new
finder.load_config(File.join(Dir.home, ".related_files_mapping.json"))
finder.load_config(".related_files_mapping.json")

files = load_files_from_stdin

related_files = files.flat_map { |file| finder.related_files(file) }.uniq

related_files.each { |file| puts file }